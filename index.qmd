---
title: "CER-BEANS: Community Engaged Research Balanced Expressions and Assessments with Nuanced Scores"
subtitle: "A Framework for Constructing Quantitative Metrics for Community Engaged Research Projects"
author:
  - name: Jeremy F Price 
    url: https://www.jeremyfprice.info/
    affiliation: IU School of Education-Indianapolis
    affiliation_url: https://education.iupui.edu/
    orcid: 0000-0002-6506-3526
license: "CC BY-SA"
mainfont: domine
sansfont: rubik
monofont: "JetBrains Mono"
highlight-style: a11y
code-overflow: wrap
reference-location: margin
cap-location: margin
link-external-icon: false
link-external-newwindow: true
repo-url: https://github.com/jeremyfprice/cer-beans
citation:
  type: document
  issued: 2023
  url: https://github.com/jeremyfprice/cer-beans
google-scholar: true
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

```{r load-libraries, message = FALSE, warning=FALSE, echo = FALSE}
library(scales)
library(gt)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggpubr)
library(ggthemes)
library(glue)
library(ggrepel)
library(ggtext)
library(showtext)
library(ggforce)
```

```{r load-fonts, echo = FALSE, include=FALSE}
font_add_google("Rubik", "rubik", regular.wt = 700)
font_add_google("JetBrains Mono", "jetbrains", regular.wt = 700)
font_add_google("Domine", "domine", regular.wt = 700)
```

```{r setup, echo=FALSE}
category_scores <- data.frame(
  project_name = character(),
  category_name = character(),
  category_impact_number = integer(),
  category_index = double(),
  category_score = integer()
  )

iu_palette <<- c(
  "#990000",
  "#FFAA00",
  "#006298",
  "#7D4C73",
  "#056E41"
  )

category_levels <<- c(
  "Participation",
  "Engagement",
  "Infrastructure",
  "Outputs",
  "Sustainability"
)

raw_impacts <<- c(
  "Participants",
  "Hours",
  "Infrastructures",
  "Outputs",
  "Partners"
)

credit_frame <- data.frame(
  x = 1,
  y = 1,
  label = glue("Community Engaged Research Balanced Expressions and Assessments with Nuanced Scores -- Generated {Sys.Date()} -- CC BY-NC-SA 4.0")
)
credit_line <<- ggplot(
  credit_frame,
  aes(
    x = x,
    y = y,
    label = label
  )
) +
  geom_richtext(
    fill = NA,
    label.color = NA,
    color = "#191919",
    size = 2.5
  ) +
  theme_light() +
  theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "transparent", color = NA)
  )

  # Source and inspiration: https://datasketch.dev/post/2020-08-09-how-to-make-spirals-with-r/
  # vogel_t <- 1:100
  # vogel_r <- sqrt(vogel_t)
  # golden_angle <- pi * (3 - sqrt(5))
  # theta <- vogel_t * golden_angle
  # vogel_x <- vogel_r * cos(theta)
  # vogel_y <- vogel_r * sin(theta)
  # vogel_coords <<- tibble::tibble(vogel_x, vogel_y)
# Archimedan
  # n_arch <- 100
  # # b separation of turns
  # t_arch <- seq(0, 3  * 2 * pi, length.out = n_arch)
  # x_arch <- (0 + 1 * t_arch) * cos(t_arch)
  # y_arch <- (0 + 1 * t_arch) * sin(t_arch)
  # arch_coords <- tibble::tibble(x_arch, y_arch)
  # arch_coords$n <- 1:n

```

```{r define-functions, echo=FALSE}
add_category <- function(the_frame,
                         the_project,
                         category_name,
                         impact_number,
                         component_score_1,
                         component_score_2) {
  the_frame <- the_frame |>
    add_row(
      project_name = the_project,
      category_name = category_name,
      category_impact_number = impact_number,
      category_index = round((component_score_1 + component_score_2) / 2,
        digits = 2
      )
    ) |>
    mutate(
      category_score = round((category_impact_number * (1 + category_index)), digits = 0)
    )
}

create_display_table <- function(the_frame,
                                 the_category,
                                 component_score_1,
                                 component_score_2,
                                 component_title_list) {
  the_table <- the_frame |>
    filter(category_name == the_category) |>
    pivot_longer(
      cols = c(
        "category_impact_number",
        "category_index",
        "category_score"
      ),
      names_to = "Component",
      values_to = "Value"
    ) |>
    select(-category_name) |>
    add_row(
      Component = "Component 1",
      Value = component_score_1,
      .after = 1
    ) |>
    add_row(
      Component = "Component 2",
      Value = component_score_2,
      .after = 2
    )
  the_table$Component <- component_title_list
  return(the_table)
}

adjust_component_score <- function(the_score, the_coefficient) {
  the_component_score <- round(the_score * the_coefficient, 2)
}

bake_donut <- function(category_scores, the_project, the_overall) {
  the_frame <- category_scores |>
    filter(project_name == the_project)
  donut_labels <- vector()
  for (i in 1:5) {
    donut_labels[i] <- glue(
      "{the_frame$category_name[i]}\n{the_frame$category_index[i]}"
    )
  }
  donut_frame <- data.frame(
    names = category_levels,
    label = donut_labels,
    score = the_frame$category_index
  )
  donut_frame$names <- factor(
    donut_frame$names,
    levels = category_levels
  )
  bean_donut <- ggdonutchart(
    donut_frame, "score",
    fill = "names", color = "#EDEBEB",
    palette = iu_palette,
    lab.font = "#191919",
    # font.family = "rubik"
  ) +
    annotate(
      geom = "text",
      x = 0.5,
      y = 0,
      label = the_overall,
      size = 18,
      # family = "jetbrains"
    ) +
    theme(
      legend.position = "none",
      panel.background = element_rect(fill = "transparent"),
      plot.background = element_rect(fill = "transparent", color = NA),
      axis.ticks = element_blank()
    )
  return(bean_donut)
}

prep_raw <- function(category_scores, the_project) {
  the.frame <- category_scores |>
    filter(project_name == the_project)
  raw_labels <- vector()

  for (i in 1:5) {
    raw_labels[i] <- glue(
      "{category_scores$category_impact_number[i]} {raw_impacts[i]}"
    )
  }

  raw_frame <- data.frame(
    names = category_levels,
    label = raw_labels,
    values = the.frame$category_impact_number,
    bean = c("BEAN", "BEAN", "BEAN", "BEAN", "BEAN")
  )

  raw_frame$names <- factor(
    raw_frame$names,
    levels = rev(category_levels)
  )

  raw_frame$values_adjusted <- rescale(raw_frame$values, to = c(3, 100))

  raw_bar <- ggplot(raw_frame, aes(x = bean, y = values_adjusted, fill = names)) +
    geom_bar(
      stat = "identity",
      width = 1,
      color = "#EDEBEB"
    ) +
    coord_flip() +
    scale_fill_manual(values = rev(iu_palette)) +
    theme_light() +
    theme(
      legend.position = "none",
      axis.title = element_blank(),
      axis.text = element_blank(),
      axis.ticks = element_blank(),
      panel.border = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "transparent"),
      plot.background = element_rect(fill = "transparent", color = NA)
    )
  return(raw_bar)
}

prep_labels <- function(category_scores, the_project) {
  the_frame <- category_scores |>
    filter(project_name == the_project)
  label_frame <- data.frame(
    x = 1,
    y = 2,
    label = glue(
      "<span style='color:#99000088;'>‚ñà</span> <span style='color:#990000;'><b>{the_frame$category_impact_number[1]}</b></span> Participants <span style='color:#FFAA0088;'>‚ñà</span> <span style='color:#FFAA00;'><b>{the_frame$category_impact_number[2]}</b></span> Engagement Hours <span style='color:#00629888;'>‚ñà</span> <span style='color:#006298;'><b>{the_frame$category_impact_number[3]}</b></span> Infrastructure Products <span style='color:#59264D88;'>‚ñà</span> <span style='color:#59264D;'><b>{the_frame$category_impact_number[4]}</b></span> Outputs <span style='color:#056E4188;'>‚ñà</span> <span style='color:#056E41;'><b>{the_frame$category_impact_number[5]}</b></span> Partners"
    )
  )

  label_line <- ggplot(
    label_frame,
    aes(
      x = x,
      y = y,
      label = label
    )
  ) +
    geom_richtext(
      fill = NA,
      label.color = NA,
      color = "#191919",
      size = 3.5
    ) +
    theme_light() +
    theme(
      legend.position = "none",
      axis.title = element_blank(),
      axis.text = element_blank(),
      axis.ticks = element_blank(),
      panel.border = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_rect(fill = "transparent"),
      plot.background = element_rect(fill = "transparent", color = NA)
    )
  return(label_line)
}

calculate_overall <- function(category_scores, the_project) {
  overall_score <- category_scores |>
    filter(project_name == the_project) |>
    tally(category_score) |>
    pull(n)
}

compile_badge <- function(the_donut, the_raw, the_labels, project_abbrev) {
  the_file <- glue("outputs/{project_abbrev}_badge.png")
  detailed_badge <- ggarrange(
    the_donut,
    the_raw,
    the_labels,
    credit_line,
    ncol = 1,
    nrow = 4,
    heights = c(8, 1, 1, 1)
  )
  ggsave(
  detailed_badge,
  filename = the_file,
  dpi = 320,
  width = 8,
  height = 8,
  units = "in"
  )
}

map_ripples <- function(the_project, the_frame) {
  the_project <- "PD @ TG"
  the_frame <- pdtg_ripple
  
  the_frame <- the_frame |>
    filter(project_name == the_project) |>
    select(-project_name)
  library(DiagrammeR)
  the_graph <- the_frame |>
    graph_from_data_frame(directed = TRUE)
  
}

map_spiral <- function(the_frame, the_colors, the_levels, the_grid) {
  the_frame <- the_frame |>
    mutate(values = ((values / sum(values)) * 100))
  the_frame$values <- round(the_frame$values, digits = 0)
  rep_frame <- rep(the_frame$name, times = the_frame$values)
  spiral_frame <- data.frame(
    group = rep_frame,
    x = vogel_coords$vogel_x,
    y = vogel_coords$vogel_y
  )
  the_spiral <- ggplot(spiral_frame) +
    geom_segment(
      aes(
        x = -10,
        y = 0,
        xend = 10,
        yend = 0
      ),
      color = "#eeeeee",
      linetype = "solid",
      linewidth = 0.01
    ) +
    geom_segment(
      aes(
        x = 0,
        y = -10,
        xend = 0,
        yend = 10
      ),
      color = "#eeeeee",
      linetype = "solid",
      linewidth = 0.01
    ) +
    geom_segment(
      aes(
        x = 0,
        y = 0,
        xend = 8,
        yend = -8
      ),
      color = "#eeeeee",
      linetype = "solid",
      linewidth = 0.01
    ) +
    geom_segment(
      aes(
        x = 0,
        y = 0,
        xend = 8,
        yend = 8
      ),
      color = "#eeeeee",
      linetype = "solid",
      linewidth = 0.01
    ) +
    geom_segment(
      aes(
        x = 0,
        y = 0,
        xend = -8,
        yend = -8
      ),
      color = "#eeeeee",
      linetype = "solid",
      linewidth = 0.01
    ) +
    geom_segment(
      aes(
        x = 0,
        y = 0,
        xend = -8,
        yend = 8
      ),
      color = "#eeeeee",
      linetype = "solid",
      linewidth = 0.01
    ) +
    geom_circle(
      aes(
        x0 = 0,
        y0 = 0,
        r = 1
      ),
      color = "#eeeeee",
      fill = "#ffffff"
    ) +
    geom_circle(
      aes(
        x0 = 0,
        y0 = 0,
        r = 5
      ),
      color = "#eeeeee"
    ) +
    geom_circle(
      aes(
        x0 = 0,
        y0 = 0,
        r = 10
      ),
      color = "#eeeeeecc"
    ) +
    geom_point(
      aes(
        x = 0,
        y = 0
      ),
      color = "#eeeeee",
      size = 2
    ) +
    geom_point(
      aes(
        x,
        y,
        color = group
      ),
      size = 6
    ) +
    coord_equal() +
    scale_color_manual(
      values = the_colors
    ) +
    theme_minimal() +
    theme(
      axis.ticks = element_blank(),
      axis.text = element_blank(),
      axis.title = element_blank(),
      panel.grid = element_blank(),
      legend.title = element_blank(),
      legend.position = "bottom",
      panel.background = element_rect(
        fill = "transparent",
        color = NA
      ),
      plot.background = element_rect(
        fill = "transparent",
        color = NA
      )
    )
}

vogel_spiral <- function(n){
  t <- 1:n
  r <- sqrt(t)
  golden_angle <- pi * (3 - sqrt(5))
  theta <- t * golden_angle
  x <- r * cos(theta)
  y <- r * sin(theta)
  d <- tibble::tibble(x, y)
  d$n <- 1:n
  d
}

archimedean_spiral <- function(n, a = 0, b = 1, turns = 3){
  # b separation of turns
  t <- seq(0, turns  * 2 *pi, length.out=n)
  x <- (a + b*t) * cos(t)
  y <- (a + b*t) * sin(t)
  d <- tibble::tibble(x, y)
  d$n <- 1:n
  d
}
```

## Introduction

> "Every little bean must be heard as well as seen!"
>
> --- Erich Maria Remarque, <cite>All Quiet on the Western Front</cite>

![A hill of important beans just waiting to be counted as imagined by Adobe Firefly](assets/hillofbeans2.jpg)

Quantitative measures capture only a small piece of the (bean) pie, but people
in academia ‚ù§Ô∏è&nbsp;**love**&nbsp;‚ù§Ô∏è putting numbers on things and counting them (beans).

Rather than sitting back and stewing like a pot of vegetarian chili while fretting
about whether or not faculty committees and administrators will count the kinds of
beans I hope they would count, I decided to create my own set of beans for them to
count.

Therefore:

**Community Engaged Research Balanced Expressions and Assessments with Nuanced Scores
(CER-BEANS)**[CER-BEANS is pronounced "Sir&nbsp;Beans."]{.aside}

I was inspired by the [Altmetric badge](https://www.altmetric.com/), so I want to
make sure to create a system of beans that is:

1. Easy to grok and nice to look at.[To [grok](https://www.britannica.com/topic/grok) something is to understand it intuitively and deeply.]{.aside}
2. Authentic and meaningful to the work and experiences of community engaged researchers.
3. Usable as a critical framing for the kind of work community engaged researchers
should be focusing on.
4. Translatable, transferable, robust, resilient, dynamic, and extensible.

How 'bout *these* beans?

![](outputs/pdtg_badge.png)

Pretty [*radicle,*](https://en.wikipedia.org/wiki/Radicle) eh?

:::{.callout-note}

## If You Choose to Die on This Hill (of Beans)...

I am open to collaboration, dialogue, and disagreement. You can even
[open an issue](https://github.com/jeremyfprice/cer-beans/issues/new) if you'd
like to make it official. Contributions are welcomed, please read the 
[Code of Conduct](https://github.com/jeremyfprice/cer-beans/blob/main/CODE_OF_CONDUCT.md).
:::

## Identifying the Metrics

> "You never cook onions with your beans. That's a recipe for tear gas."
>
> --- Justin Swapp, <cite>The Shadow's Servant</cite>

![An image of medieval academics counting beans as imagined by Adobe Firefly](assets/beancounters3.jpg)

When evaluating community-engaged programs, it's important to consider various metrics that assess different aspects of the program's effectiveness and impact.

:::{.callout-warning}

## If You Had a Roomful of Awards that Didn't Mean Beans...

It is important to remember a number, a score, or even a collection or bean hill
of scores or numbers, *do not tell the whole story* of your community engaged research.
This framework is provided to *help you tell that story* using a system that is
easily recognizable and considered a valid form of evidence.

These numbers are a guidepost for your readers--or more likely--your evaluators.
:::

Now that I've provided the warning, remember that academics are first and foremost
makers of bean stalks[I make bean stalks, I'm<br />A builder, like yourself.<br />-- Edna St. Vincent Millay, [The Bean-Stalk](https://americanliterature.com/author/edna-st-vincent-millay/poem/the-bean-stalk)]{.aside}: we are trained to make cases and construct narratives.
Here are some tips for you to consider about what CER-BEANS *does* provide for
you as you construct a narrative around your work:

::: {.callout-tip}

## Ways to Build Bean Stalks

* ü™û **Reflection:** It provides an overall reflection on your work and where you have focused your energies. CER-BEANS gives you an indication of the impact your work has had, allowing you to discuss your successes.

* üì∏ **Snapshot:** It provides a snapshot of where you are in a longer process, what has worked well so far, and where you will be focusing your efforts in the near future.

* üó∫Ô∏è **Map:** It provides a rough map of where you and your collaborators, partners, and participants can take the work moving forward.

:::

CER-BEANS focuses on *five categories* and they each
result in an `category score`. Each of the category scores contribute to the
`overall score`. These are the five categories:

1. Participants
2. Engagement
3. Infrastructures
4. Outputs
5. Sustainability

Each of the `category scores` ($S_C$) follow a predictable pattern, that includes an
`impact number` ($I_C$) that is amplified by a set of **category component ratings** ($R_C$,
individual ratings represented by $r_{C1} \ldots r_C$). This is the general formula
for a `category score`:

$$
S_C = I_C \left(1 + \frac{\sum r_{C_1} \ldots r_{C_n}}{|R_C|}\right)
$$

The process for computing each of the `category scores` is essentially calculating the
average for the ratings in the category and then adding 1 to this average since
the ratings are between 0 and 1 and only numbers greater than 1 will amplify things.
The `amplifier score` is then multiplied by the `impact number`, which can be the
number of participants, contact hours, institutional partners, etc.

The categories contribute to the `overall score` ($S_O$) as a straight-forward
summation of all the category scores, where $s$ represents the `category scores`,
$x$ represents the set of categories, and $n$ is the number of categories:

$$
S_O = \sum_{x=1}^n s_x
$$

This `overall score` is  similar to the [Altmetric Attention Score](https://www.altmetric.com/about-us/our-data/donut-and-altmetric-attention-score/#:~:text=The%20Altmetric%20Attention%20Score%20is%20an%20automatically%20calculated,3%20main%20factors:) in that
it is a *weighted count*. The `overall score` increases 

Each of these categories and their components are described in some detail below. The
idea, the math, the concepts, are all licensed under a [CC BY-SA 4.0](https://creativecommons.org/licenses/by-sa/4.0/) license[The code itself is licensed similarly under an [MIT License](https://github.com/jeremyfprice/cer-beans/blob/main/LICENSE).]{.aside}, so you are welcome to take these ideas and adapt them to your particular needs and preferences
(as long as you give credit where credit is due and share your adapted work alike).

## Participants

People Involved

```{r participants-frame, echo = FALSE}
participants_frame <- data.frame(
  marginalized_proportions = c(
    "No Marginalized Participants",
    "A Few Marginalized Participants",
    "Some Marginalized Participants",
    "Just Under Half Marginalized Participants",
    "About Half Marginalized Participants",
    "Just Over Half Marginalized Participants",
    "Mostly Marginalized Participants",
    "Predominantly Marginalized Participants",
    "Nearly All Marginalized Participants",
    "All Marginalized Participants"
  ),
  intersectionally_marginalized = c(
    "No Intersectionally Marginalized Participants",
    "A Few Intersectionally Marginalized Participants",
    "Some Intersectionally Marginalized Participants",
    "Just Under Half Intersectionally Marginalized Participants",
    "About Half Intersectionally Marginalized Participants",
    "Just Over Half Intersectionally Marginalized Participants",
    "Mostly Marginalized Intersectionally Participants",
    "Predominantly Intersectionally Marginalized Participants",
    "Nearly All Intersectionally Marginalized Participants",
    "All Marginalized Intersectionally Participants"
  ),
  participants_value = c(
    0.1,
    0.25,
    0.33,
    0.4,
    0.5,
    0.75,
    0.85,
    0.9,
    0.95,
    1
  ))
gt(participants_frame)
```

### Number of Participants

How many participants involved? This is $p_n$. For this example, there are **6 participants**.

```{r, echo = FALSE}
number_of_participants <- 7
tg_number_of_participants <- 70
```

### Marginalized Proportions Score

How many of the participants represent and come from marginalized identities and
communities? This is $p_m$.

Also, are you working directly with these marginalized  participants, or are you
working with others (such as teachers or health care workers) who are working with
these identities and communities?

```{r, echo = FALSE}
marginalized_proportions_value <- 1
marginalized_proportions_coefficient <- 1
tg_marginalized_proportions_value <- 0.95
tg_marginalized_proportions_coefficient <- 0.85
```

### Intersectionally Marginalized Score

```{r}
intersectionally_marginalized_value <- 1
intersectionally_marginalized_coefficient <- 1
tg_intersectionally_marginalized_value <- 0.95
tg_intersectionally_marginalized_coefficient <- 0.85
# 0.85 indicates one degree away, e.g., students of teachers, while 1 indicates
# direct engagement
```

### Calculate Participation Score

$$
p_s = p_n \left( 1 + \frac{(\beta_m \cdot p_m + \beta_i \cdot p_i)}{2} \right)
$$

```{r calculate-participant-score, echo = FALSE}

marginalized_proportions_score <- adjust_component_score(
  marginalized_proportions_value,
  marginalized_proportions_coefficient
)

intersectionally_marginalized_score <- adjust_component_score(
  intersectionally_marginalized_value,
  intersectionally_marginalized_coefficient
)

category_scores <- category_scores |>
  add_category(
    "STEM Studio",
    "Participation",
    number_of_participants,
    marginalized_proportions_score,
    intersectionally_marginalized_score
  )

tg_marginalized_proportions_score <- adjust_component_score(
  tg_marginalized_proportions_value,
  tg_marginalized_proportions_coefficient
)

tg_intersectionally_marginalized_score <- adjust_component_score(
  tg_intersectionally_marginalized_value,
  tg_intersectionally_marginalized_coefficient
)

category_scores <- category_scores |>
  add_category(
    "PD @ TG",
    "Participation",
    tg_number_of_participants,
    tg_marginalized_proportions_score,
    tg_intersectionally_marginalized_score
  )

participation_component_list <- c("Number of Participants",
                                  "Marginalized Participation Score",
                                  "Intersectionally Marginalized Participation Score",
                                  "Participation Category Index",
                                  "Participation Category Score")
rank_adjusted <- FALSE

if(marginalized_proportions_coefficient < 1) {
  participation_component_list[2] <- "Marginalized Participation Score*"
  rank_adjusted <- TRUE
}

if(intersectionally_marginalized_value < 1) {
  participation_component_list[3] <- "Intersectionally Marginalized Participation Score*"
  rank_adjusted <- TRUE
}

#participation_table <- category_scores |>
#  #select(-project_name) |>
#  create_display_table(
#    "Participation",
#    marginalized_proportions_value,
#    intersectionally_marginalized_value,
#    participation_component_list
#  )

#participation_table <- participation_table |>
#  gt()

#if(rank_adjusted == TRUE) {
#  participation_table <- participation_table |>
#      tab_footnote(footnote = "*Adjusted scores.")
#}

#participation_table
```

## Engagement

Number of contact hours $e_h$.

```{r engagement-frame, echo=FALSE}
engagement_frame <- data.frame(
  frequency = c(
    "Once",
    "Once Per Year",
    "Several Times Per Year",
    "Every Other Month",
    "Once Per Month",
    "Every Other Week",
    "Once Per Week",
    "2-4 Times Per Week",
    "5 Times Per Week",
    "Daily"
  ),
    duration = c(
    "One Day",
    "Less Than A Week",
    "One Week",
    "2-3 Weeks",
    "One Month",
    "One Semester",
    "One Year",
    "2-3 Years",
    "3-10 Years",
    "10+ Years"
  ),
  value = c(
    0.1,
    0.25,
    0.33,
    0.4,
    0.5,
    0.75,
    0.85,
    0.9,
    0.95,
    1
  ))

engagement_frame |>
  gt()
```

### Engagement Hours

```{r}
engagement_hours <- 16
tg_engagement_hours <- 18
```

### Frequency

```{r frequency-score}
frequency_score <- 0.85
tg_frequency_score <- 0.50
```
  
### Duration

```{r duration-score}
duration_score <- 0.75
tg_duration_score <- 0.85
```

### Calculate Engagement Score

$$
e_s = e_h \left(1 + \frac{(e_d + e_f)}{2}\right)
$$

```{r calculate-engagement-score}
category_scores <- category_scores |>
  add_category(
    "STEM Studio",
    "Engagement",
    engagement_hours,
    frequency_score,
    duration_score
  )

category_scores <- category_scores |>
  add_category(
    "PD @ TG",
    "Engagement",
    tg_engagement_hours,
    tg_frequency_score,
    tg_duration_score
  )

engagement_component_list <- c("Number of Contact Hours",
                                  "Frequency Component Score",
                                  "Duration Component Score",
                                  "Engagement Category Index",
                                  "Engagement Category Score")

#engagement_table <- category_scores |>
#  select(-project_name) |>
#  create_display_table(
#    "Engagement",
#    frequency_score,
#    duration_score,
#    engagement_component_list
#  )

#engagement_table |>
#  gt()
```

## Infrastructure Score

```{r infrastructure-frame, echo=FALSE}
infrastructure_frame <- data.frame(
  purpose = c(
    "Promoting Efficiency Only",
    "Promoting Predominantly Efficiency And Recognizing Plurality and Multivocality",
    "Promoting Mostly Efficiency And Recognizing Plurality and Multivocality",
    "Promoting Mostly Efficiency And Recognizing Plurality, Multivocality, and Honor",
    "Promoting Efficiency, Plurality, Multivocality, and Honor Equitably"
  ),
    co_construction = c(
    "Initiation and Construction From One Party",
    "Initiation and Construction From One Party With Feedback By Another",
    "Initiation From One Party and Construction By Another",
    "Initiated and Constructed Mostly Equitably",
    "Initiated and Constructed Equitably"
  ),
  value = c(
    0.1,
    0.5,
    0.9,
    0.95,
    1
  ))

infrastructure_frame |>
  gt()
```

### Number of Intrastructure/Intermediate Products

```{r}
number_of_infrastructure_products <- 8
tg_number_of_infrastructure_products <- 10
```

### Infrastructure Purpose
```{r}
infrastructure_purpose <- 0.90
tg_infrastructure_purpose <- 0.90
```

### Infrastructure Co-Construction
```{r}
infrastructure_co_construction <- 0.10
tg_infrastructure_co_construction <- 0.10
```

### Calculate Infrastructure Score

$$
i_s = i_p \left(1 + \frac{(i_u + i_c)}{2}\right)
$$

```{r calculate-infrastructure-score}
category_scores <- category_scores |>
  add_category(
    "STEM Studio",
    "Infrastructure",
    number_of_infrastructure_products,
    infrastructure_purpose,
    infrastructure_co_construction
  )

category_scores <- category_scores |>
  add_category(
    "PD @ TG",
    "Infrastructure",
    tg_number_of_infrastructure_products,
    tg_infrastructure_purpose,
    tg_infrastructure_co_construction
  )

infrastructure_component_list <- c("Number of Infrasctructure Products",
                                  "Infrastructure Purpose Score",
                                  "Infrastructure Co-Construction Score",
                                  "Infrastructure Category Index",
                                  "Infrastructure Category Score")

#infrastructure_table <- category_scores |>
#  select(-project_name) |>
#  create_display_table(
#    "Infrastructure",
#    infrastructure_purpose,
#    infrastructure_co_construction,
#    infrastructure_component_list
#  )

#infrastructure_table |>
#  gt()
```

## Outputs Score

```{r outputs-frame, echo=FALSE}
outputs_frame <- data.frame(
  venues = c(
    "Only One Type of Venue",
    "Predominantly One Type of Venue",
    "Mostly One Type of Venue",
    "Almost Even Mix of Venues",
    "Even Mix of Venues"
  ),
    inclusion = c(
    "No Inclusion",
    "Member Check Opportunities",
    "Inclusion in Writing",
    "Inclusion in Data Curation, Analysis, and Writing",
    "Full Partnership"
  ),
  value = c(
    0.10,
    0.50,
    0.90,
    0.95,
    1
  ))

outputs_frame |>
  gt()
```

### Number of Outputs Products

```{r}
number_of_outputs <- 1
tg_number_of_outputs <- 0
```

### Distribution of Venues

```{r}
distribution_of_venues <- 0.10
tg_distribution_of_venues <- 0.10
```

### Inclusion of Participants and Partners

```{r}
inclusion_of_participants <- 0.90
tg_inclusion_of_participants <- 0.10
```

### Calculate Outputs Score

$$
o_s = o_p \left(1 + \frac{(o_v + o_i)}{2}\right)
$$

```{r calculate-outputs-score}
category_scores <- category_scores |>
  add_category(
    "STEM Studio",
    "Outputs",
    number_of_outputs,
    distribution_of_venues,
    inclusion_of_participants
  )

category_scores <- category_scores |>
  add_category(
    "PD @ TG",
    "Outputs",
    tg_number_of_outputs,
    tg_distribution_of_venues,
    tg_inclusion_of_participants
  )

outputs_component_list <- c("Number of Output Products",
                                  "Distribution of Venues Score",
                                  "Inclusion of Participants Score",
                                  "Outputs Category Index",
                                  "Outputs Category Score")

#outputs_table <- category_scores |>
#  select(-project_name) |>
#  create_display_table(
#    "Outputs",
#    distribution_of_venues,
#    inclusion_of_participants,
#    outputs_component_list
#  )

#outputs_table |>
#  gt()
```

## Sustainability

```{r sustainability-frame, echo=FALSE}
sustainability_frame <- data.frame(
  responsibility = c(
    "Responsibility Distributed to One Partner",
    "Responsibility Predominantly Distributed to One Partner",
    "Responsibility Mostly Distributed to One or More Partners",
    "Almost Equitable Distribution of Responsibility Across Partners",
    "Equitable Distribution of Responsibility Across Partners"
  ),
    material = c(
    "No Material Support",
    "Material Support Predominantly Through One Partner",
    "Material Support Mostly Through One or More Partners",
    "Material Support Almost Equitably Distributed Across Partners",
    "Equitable Material Support Across Partners"
  ),
  value = c(
    0.1,
    0.5,
    0.9,
    0.95,
    1
  ))

sustainability_frame |>
  gt()
```

### Number of Institutional Partners

```{r}
number_of_partners <- 2
tg_number_of_partners <- 1
```

### Distribution of Responsibility

```{r}
distribution_of_responsibility <- 0.5
tg_distribution_of_responsibility <- 0.5
```

### Distribution of Material Support

```{r}
distribution_of_material_support <- 0.5
tg_distribution_of_material_support <- 0.5
```

### Calculate Sustainability Score

$$
s_s = s_p \left(1 + \frac{(s_r + s_m)}{2}\right)
$$

```{r calculate-sustainability-score}
category_scores <- category_scores |>
  add_category(
    "STEM Studio",
    "Sustainability",
    number_of_partners,
    distribution_of_responsibility,
    distribution_of_material_support
  )

category_scores <- category_scores |>
  add_category(
    "PD @ TG",
    "Sustainability",
    tg_number_of_partners,
    tg_distribution_of_responsibility,
    tg_distribution_of_material_support
  )

sustainability_component_list <- c("Number of Partners",
                                  "Distribution of Responsibiilty Score",
                                  "Distribution of Material Support Score",
                                  "Sustainability Category Index",
                                  "Sustainability Category Score")

#sustainability_table <- category_scores |>
#  select(-project_name) |>
#  create_display_table(
#    "Sustainability",
#    distribution_of_responsibility,
#    distribution_of_material_support,
#    sustainability_component_list
#  )

#sustainability_table |>
#  gt()
```

## Ripple Effects

```{r echo = TRUE}
mu_ripple <- 0.55
```

$$
\lambda_r = 10 \cdot \frac{\log(\mu_r + 1)}{d_r \cdot \log(p_n + 1)}
$$

$$
\eta_r = {\lambda_r \cdot p_\delta \mid \delta \in {1, 2, \ldots, n}}
$$

```{r}
pdtg_ripple <- data.frame(
  group = c(1, 2, 3),
  group_name = c("Teachers", "Students", "Family Members"),
  values = c(70, 522, 2088)
)

spiral_palette <- c(
  "1" = "#990000",
  "2" = "#F23A3F",
  "3" = "#FFD6DB",
  "4" = "#FFF7F8"
)


pdtg_ripple$adj_values <- ((pdtg_ripple$values / sum(pdtg_ripple$values)) * 100)
pdtg_ripple$adj_values <- round(pdtg_ripple$adj_values, digits = 0)
#pdtg_ripple <- pdtg_ripple |>
#  mutate(adj_values = if_else(adj_values == 0, 1, adj_values))
pdtg_ripple$lambda_ripple <- (log(mu_ripple + 1)) /
  (pdtg_ripple$group * log(pdtg_ripple$values + 1)) * 10
pdtg_ripple$ripple_score <- pdtg_ripple$lambda_ripple * pdtg_ripple$values
pdtg_ripple$ripple_score <- round(pdtg_ripple$ripple_score, digits = 0)
#pdtg_ripple$adj_score <- ((pdtg_ripple$ripple_score / sum(pdtg_ripple$ripple_score)) * 100)
#pdtg_ripple$adj_score <- round(pdtg_ripple$adj_score, digits = 0)

pdtg_ripple <- pdtg_ripple |>
  mutate(group_name = glue("{values} {group_name}\n(Œ∑ = {ripple_score})"))

total_ripple_score <- sum(pdtg_ripple$ripple_score)

rep_frame <- data.frame(
  group = rep(pdtg_ripple$group, times = pdtg_ripple$adj_values),
  group_name = rep(pdtg_ripple$group_name, times = pdtg_ripple$adj_values)
  )
spiral_frame <- vogel_spiral(sum(pdtg_ripple$adj_values))
spiral_frame$group_name = rep_frame$group_name
spiral_frame$group = rep_frame$group
spiral_frame$group <- factor(
    spiral_frame$group,
    levels = c(1:max(spiral_frame$group))
  )
pdtg_spiral <- ggplot(spiral_frame) +
  geom_segment(
    aes(
      x = -10,
      y = 0,
      xend = 10,
      yend = 0
    ),
    color = "#eeeeee",
    linetype = "solid",
    linewidth = 0.01
  ) +
  geom_segment(
    aes(
      x = 0,
      y = -10,
      xend = 0,
      yend = 10
    ),
    color = "#eeeeee",
    linetype = "solid",
    linewidth = 0.01
  ) +
  geom_segment(
    aes(
      x = 0,
      y = 0,
      xend = 8,
      yend = -8
    ),
    color = "#eeeeee",
    linetype = "solid",
    linewidth = 0.01
  ) +
  geom_segment(
    aes(
      x = 0,
      y = 0,
      xend = 8,
      yend = 8
    ),
    color = "#eeeeee",
    linetype = "solid",
    linewidth = 0.01
  ) +
  geom_segment(
    aes(
      x = 0,
      y = 0,
      xend = -8,
      yend = -8
    ),
    color = "#eeeeee",
    linetype = "solid",
    linewidth = 0.01
  ) +
  geom_segment(
    aes(
      x = 0,
      y = 0,
      xend = -8,
      yend = 8
    ),
    color = "#eeeeee",
    linetype = "solid",
    linewidth = 0.01
  ) +
  geom_circle(
    aes(
      x0 = 0,
      y0 = 0,
      r = 1
    ),
    color = "#eeeeee",
    fill = "#ffffff"
  ) +
  geom_circle(
    aes(
      x0 = 0,
      y0 = 0,
      r = 5
    ),
    color = "#eeeeee"
  ) +
  geom_circle(
    aes(
      x0 = 0,
      y0 = 0,
      r = 10
    ),
    color = "#eeeeeecc"
  ) +
  geom_point(
    aes(
      x = 0,
      y = 0
    ),
    color = "#eeeeee",
    size = 2
  ) +
  geom_point(
    aes(
      x,
      y,
      color = group
    ),
    size = 6
  ) +
  coord_equal() +
  scale_color_manual(
    labels = pdtg_ripple$group_name,
    values = spiral_palette
  ) +
  theme_minimal() +
  theme(
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_blank(),
    legend.position = "bottom",
    panel.background = element_rect(
      fill = "transparent",
      color = NA
    ),
    plot.background = element_rect(
      fill = "transparent",
      color = NA
    )
  )


pdtg_spiral
```

## Overall Score

> "Red Beans and Ricely Yours"
>
> -- Louis Armstrong

!["Here are my beans, come count them!" As imagined by Adobe Firefly.](assets/introbeans.jpg)

$$
S_O = \sum_{x=1}^n s_x
$$

```{r}
stst_overall_score <- calculate_overall(category_scores, "STEM Studio")
pdtg_overall_score <- calculate_overall(category_scores, "PD @ TG")
```

The Overall Score $S_O$ for the STEM Studio is `r stst_overall_score` while the
Overall Score $S_O$ for the Professional Development is `r pdtg_overall_score`.

## Overall Representation

```{r represent, fig.showtext=TRUE, warning=FALSE, message=FALSE, echo=FALSE}

category_names <- c(
  "Sustainability",
  "Outputs",
  "Infrastructure",
  "Engagement",
  "Participation"
)

pdtg_frame <- category_scores |>
  filter(project_name == "PD @ TG") |>
  mutate(category_score = category_score + 1) |>
  mutate(category_name = glue("{category_name}\n(i = {category_index})"))
pdtg_frame$category <- c(1, 2, 3, 4, 5)

  pdtg_frame <- pdtg_frame |>
    mutate(adj_score = ((category_score / sum(category_score)) * 100))
  pdtg_frame$adj_score <- round(pdtg_frame$adj_score, digits = 0)

arch_frame <- archimedean_spiral(sum(pdtg_frame$adj_score))
arch_frame$category_name <- rep(pdtg_frame$category_name, times = pdtg_frame$adj_score)
arch_frame$category <- rep(pdtg_frame$category, times = pdtg_frame$adj_score)
arch_frame$category <- factor(
  arch_frame$category,
  levels = c("1", "2", "3", "4", "5")
)
#arch_frame <- data.frame(
#  category = rep_frame,
#  x = arch_coords$x_arch,
#  y = arch_coords$y_arch)

g1 <- ggplot(arch_frame) + 
    geom_segment(
    aes(
      x = -16,
      y = 0,
      xend = 16,
      yend = 0
    ),
    color = "#eeeeee",
    linetype = "solid",
    linewidth = 0.01
  ) +
  geom_segment(
    aes(
      x = 0,
      y = -16,
      xend = 0,
      yend = 16
    ),
    color = "#eeeeee",
    linetype = "solid",
    linewidth = 0.01
  ) +
  geom_segment(
    aes(
      x = 0,
      y = 0,
      xend = 15,
      yend = -15
    ),
    color = "#eeeeee",
    linetype = "solid",
    linewidth = 0.01
  ) +
  geom_segment(
    aes(
      x = 0,
      y = 0,
      xend = 15,
      yend = 15
    ),
    color = "#eeeeee",
    linetype = "solid",
    linewidth = 0.01
  ) +
  geom_segment(
    aes(
      x = 0,
      y = 0,
      xend = -15,
      yend = -15
    ),
    color = "#eeeeee",
    linetype = "solid",
    linewidth = 0.01
  ) +
  geom_segment(
    aes(
      x = 0,
      y = 0,
      xend = -15,
      yend = 15
    ),
    color = "#eeeeee",
    linetype = "solid",
    linewidth = 0.01
  ) +
  geom_circle(
    aes(
      x0 = 0,
      y0 = 0,
      r = 1
    ),
    color = "#eeeeee",
    fill = "#ffffff"
  ) +
  geom_circle(
    aes(
      x0 = 0,
      y0 = 0,
      r = 5
    ),
    color = "#eeeeee"
  ) +
  geom_circle(
    aes(
      x0 = 0,
      y0 = 0,
      r = 10
    ),
    color = "#eeeeeecc"
  ) +
  geom_circle(
    aes(
      x0 = 0,
      y0 = 0,
      r = 15
    ),
    color = "#eeeeeecc"
  ) +
  geom_point(aes(x,y, color = category), size = 8) + coord_equal() +
  scale_color_manual(
    values = iu_palette,
    labels = pdtg_frame$category_name) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_blank(),
    panel.background = element_rect(
      fill = "transparent",
      color = NA
    ),
    plot.background = element_rect(
      fill = "transparent",
      color = NA
    )
  ) +
  guides(color = guide_legend(nrow = 1, byrow = TRUE))

arch_title <- data.frame(
  x = 1,
  y = 1,
  label = glue("Overall Score <b>{pdtg_overall_score}</b>")
)
arch_line <<- ggplot(
  arch_title,
  aes(
    x = x,
    y = y,
    label = label
  )
) +
  geom_richtext(
    fill = NA,
    label.color = NA,
    color = "#ffffff",
    size = 9
  ) +
  theme_light() +
  theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "#990000aa", color = "#990000aa")
  )
#arch_line

ripple_title <- data.frame(
  x = 1,
  y = 1,
  label = glue("Ripple Effects <b>{total_ripple_score}</b>")
)
ripple_line <<- ggplot(
  ripple_title,
  aes(
    x = x,
    y = y,
    label = label
  )
) +
  geom_richtext(
    fill = NA,
    label.color = NA,
    color = "#ffffff",
    size = 9
  ) +
  theme_light() +
  theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "#990000aa", color = "#990000aa")
  )
#ripple_line


indicator_title <- data.frame(
  x = 1,
  y = 1,
  label = "<b>Indicators</b>")

indicator_line <<- ggplot(
  indicator_title,
  aes(
    x = x,
    y = y,
    label = label
  )
) +
  geom_richtext(
    fill = NA,
    label.color = NA,
    color = "#ffffff",
    size = 9
  ) +
  theme_light() +
  theme(
    legend.position = "none",
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "transparent"),
    plot.background = element_rect(fill = "#990000aa", color = "#990000aa")
  )

#cer_score <- ggarrange(arch_line,  g1, ncol = 2, widths = c(2.5, 12))
#re_score <- ggarrange(ripple_line, pdtg_spiral, ncol = 2, widths = c(2.5, 12))

top_badge <- ggarrange(
  arch_line,
  NULL,
  ripple_line,
  g1,
  NULL,
  pdtg_spiral,
  ncol = 3,
  nrow = 2,
  widths = c(14.5, 2, 14.5),
  heights = c(2, 14.5))

indicator_frame <- category_scores |>
  filter(project_name == "PD @ TG") |>
  select(category_name, category_impact_number)
indicator_frame$x <- c(1, 2, 3, 4, 5)
indicator_frame$y <- 0
indicator_frame$category_name <- factor(
  indicator_frame$category_name,
  levels = category_levels
)
correct_infrastructure <- if_else(
  pdtg_frame$category_impact_number[3] == 1,
  "Infrastructure Product",
  "Infrastructure Products"
  )
correct_output <- if_else(
  pdtg_frame$category_impact_number[4] == 1,
  "Output",
  "Outputs"
  )
correct_partner <- if_else(
  pdtg_frame$category_impact_number[5] == 1,
  "Partner",
  "Partners"
  )

indicator_frame$category_labels <- c(
  glue("{indicator_frame$category_impact_number[1]} Participants"),
  glue("{indicator_frame$category_impact_number[2]} Engagement Hours"),
  glue("{indicator_frame$category_impact_number[3]} {correct_infrastructure}"),
  glue("{indicator_frame$category_impact_number[4]} {correct_output}"),
  glue("{indicator_frame$category_impact_number[5]} {correct_partner}")
  )


indicator_bubbles <- ggplot(
  indicator_frame,
  aes(
    x = x,
    y = y,
    size = category_impact_number,
    color = category_name
  )
) +
  geom_point() +
  xlim(0, 6) +
  scale_color_manual(
    values = iu_palette,
    labels = indicator_frame$category_labels
  ) +
  scale_size(range = c(0.1, 50)) +
  guides(
    fill = FALSE,
    size = FALSE
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_blank(),
    panel.background = element_rect(
      fill = "transparent",
      color = NA
    ),
    plot.background = element_rect(
      fill = "transparent",
      color = NA
    )
  )
  

# # batter_frame <- category_scores |>
# #   filter(project_name == "PD @ TG") |>
# #   select(category_name, category_impact_number, category_index) |>
# #   mutate(adj_indicator = ((category_impact_number + 1) / (sum((category_impact_number) + 1))) * 100) |>
# #   select(category_name, adj_indicator)
# batter_frame$adj_indicator <- round(batter_frame$adj_indicator, digits = 0)
# correct_infrastructure <- if_else(pdtg_frame$category_impact_number[3] == 1, "Infrastructure Product", "Infrastructure Products")
# correct_output <- if_else(pdtg_frame$category_impact_number[4] == 1, "Output", "Outputs")
# correct_partner <- if_else(pdtg_frame$category_impact_number[5] == 1, "Partner", "Partners")
# batter_frame$category_name <- c(
#   glue("{pdtg_frame$category_impact_number[1]} Participants"),
#   glue("{pdtg_frame$category_impact_number[2]} Engagement Hours"),
#   glue("{pdtg_frame$category_impact_number[3]} {correct_infrastructure}"),
#   glue("{pdtg_frame$category_impact_number[4]} {correct_output}"),
#   glue("{pdtg_frame$category_impact_number[5]} {correct_partner}")
#   )
# 
# library(waffle)
# indicator_waffle <- waffle(batter_frame, rows = 4, colors = iu_palette, legend_pos = "bottom")
#ggplot(batter_frame, aes(fill = category_name, values = adj_indicator)) +
#  geom_waffle(n_rows = 10)

#stst_donut <- bake_donut(category_scores, "STEM Studio", stst_overall_score)
#pdtg_donut <- bake_donut(category_scores, "PD @ TG", pdtg_overall_score)
#pdtg_donut
#stst_raw_bar <- prep_raw(category_scores, "STEM Studio")
#pdtg_raw_bar <- prep_raw(category_scores, "PD @ TG")


#test <- ggarrange(pdtg_spiral, pdtg_raw_bar, ncol = 1, nrow = 2)
#test2 <- ggarrange(pdtg_donut, test, ncol = 2, nrow = 1)

#stst_labels <- prep_labels(category_scores, "STEM Studio")
#pdtg_labels <- prep_labels(category_scores, "PD @ TG")

full_badge <- ggarrange(
  top_badge,
  indicator_line,
  indicator_bubbles,
  credit_line,
  ncol = 1,
  nrow = 4,
  heights = c(
    16,
    1.5,
    8,
    1
    )
  )
#full_badge

ggsave("outputs/pdtg_badge.png", full_badge, width = 16, height = 10, units = "in", dpi = 320)
ggsave("outputs/pdtg_badge.pdf", full_badge, width = 16, height = 10, units = "in", dpi = 320)

#stst_badge <- compile_badge(
#  stst_donut,
#  stst_raw_bar,
#  stst_labels,
#  "stst"
#)

#pdtg_badge <- compile_badge(
#  pdtg_donut,
#  pdtg_raw_bar,
#  pdtg_labels,
#  "pdtg"
#)
```

### Professional Development Example

An example of a detailed badge for a professional development program at a school. This badge contains multiple levels of information including the overall score, the ripple effect score, and direct indicators.

:::{.column-page-inset}
![](outputs/pdtg_badge.png)
:::
